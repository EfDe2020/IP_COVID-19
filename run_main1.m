close all; clearvars;

global sigma alpha1 alpha2 Mort_Rate pQ pQR pC pN pR wC wR NC scenario_p JDI JAI K Pos Posl N J T1 T0 Country I0 D0 H0 delay delay_pc Type J_id Z_tau JZ1 JZ2 kappa;

%% Initialization
% Model parameters
sigma = 1/7; % incubation rate [1/12 1/2]
Mort_Rate = 0.034; % mortality rate is 3.4 (for China)
delay = 10; % nominal value
delay_pc = 12; % delay before increasing the stricteness of confinement to pC
kappa = 0.1; % ration between sigma and recovery rate for E
script = @script2;

% Confinement parameters
pQ = 0.7; % number of contacts in quarantine
pQR = 0.3; % number of contacts in relaxed quarantine
pN = 4.5; % number of contacts in normal state
pR = 0.5; % number of contacts in relaxed quarantine
pC = 0.5; % number of contacts in clustering

% Scenario of quarantine 
wC = 8; % weeks in quarantine
wR = 2*wC; % weeks in relaxed quarantine
NC = 1; % number cycles to simulate

% Identification and prediction
delta = .075; % the level of uncertainty for IP
delta_m = 1; % magnifier for initial conditions of IP
JDI = 5; JAI = 12; % days used for identification of alpha
Z_tau = 10; % days for identification of delay
JZ1 = 25; % number of days to use for identification of delay
JZ2 = 55; % number of days to use for identification of delay_pc
scenario_p = 1; % the algorithm for identification
if (scenario_p == 1)
    K = 5; % length of moving window to estimate the values of parameters
else
    K = 10; % minimal length of window to estimate the values of parameters
end
J_id = 0; % the number of days used for the model verification

% Misc
Pos = [200 200 900 600];
Posl = [200 200 1500 600];
Type = 1; % type of the plot
Imperial = 0; % 1 = use of Imperial College parameters; if not use of Cmmdi parameters + delay tuning for each country

%% France
Country = 'France';

% ARS statistics from 12/03
I0 = [2876 3661 4499 5423 6633 7730 9134 10995 12612 14459 16018 19856 22302 25230 29155 32964 37575 40174 44550 52128 56989 59105 64338 68605 70478 74389 78167 82048 86334 90676 93790 95403 98076 103573 106206 108847 109252 111821 112606 114657 117324 119151 120804 122577 124114 124575 125770 126835 128442 129581 130185 130979 131287 131863 132967 137150 137779 138421 138854 139063 139519 140227 140734 141356 141919 142291 142411 142903 143427 143845 144163 144566 144806 144921 145279 145555 145746 149071 149668 151496 151753 152091 151325]; % detected infected
D0 = [63 79 91 127 148 175 264 372 450 562 674 860 1100 1331 1696 1995 2314 2606 3024 3523 4403 5387 6507 7560 8078 8911 10328 10869 12210 13197 13832 14393 14967 15729 17167 17920 18681 19323 19718 20265 20796 21340 21856 22245 22614 22856 23293 23660 24087 24376 24594 24760 24895 25201 25531 25809 25987 26230 26310 26380 26643 26991 27074 27425 27529 27625 28108 28239 28022 28132 28215 28289 28332 28367 28432 28530 28596 28662 28714 28771 28802 28833 28940]; % detected deaths
H0 = [12 12 12 12 12 12 12 12 12 12 2200 2200 3288 3900 4948 5700 6624 7132 7923 9444 10935 12428 14008 15438 16183 17250 19337 21254 23200 24932 26391 27186 27718 28805 30995 32812 34420 35983 36578 37409 39181 40657 42088 43493 44594 44903 45513 46886 48228 49476 50212 50562 50784 51371 52736 53972 55027 55782 56038 56217 56724 57785 58673 59605 60448 61066 61213 61728 62563 63354 63858 64209 64547 64617 65199 65879 66584 67191 67803 68268 68355 68440 68812]; % detected recovered

N = 67064000; % population in FR
J = length(I0);
T1 = 4; % the date of quarantine
wC = 8;
wR = 2*wC;
T0 = datetime(2020,3,12); % the initial date for data

if (Imperial == 1) % Imperial
    alpha1 = 53; alpha2 = alpha1;
    pQ = 1.5; pN = 4; pR = 2.75;
else
    alpha1 = 16.7; alpha2 = alpha1;
    delay = 5; delay_pc = 20;
    pN = 3; pC = 0.2;
end

disp(' ');
disp([' ***' Country '*** ']);
disp(' ');

script(delta,delta,delta_m);
input('Press ENTER to proceed, please')
close all;

%% Italy
Country = 'Italy';

% Statistics from 05/03 (eficiens + hopkins)
I0 = [3858 4636 5883 7375 9172 10149 12462 15113 17660 21157 24747 27980 31506 35713 41035 47021 53578 59158 63927 69176 74386 80589 86498 92472 97689 101739 105792 110574 115242 119827 124632 128948 132547 135586 139422 143626 147577 152271 156363 159516 162488 165155 168941 172434 175925 178972 181228 183957 187327 189973 192994 195351 197675 199414 201505 203591 205463 207428 209328 210717 211938 213013 214457 215858 217185 218268 219070 219814 221216 222104 223096 223885 224760 225435 225886 226699 227364 228006 228658 229327 229858 230158 230555 231139 231732 232248 232664 233019 233197 233515]; % detected infected
D0 = [148 197 233 366 463 631 827 1016 1266 1441 1809 2158 2503 2978 3405 4032 4825 5476 6077 6820 7503 8215 9134 10023 10779 11591 12428 13155 13915 14681 15362 15887 16523 17127 17669 18279 18849 19468 19899 20465 21067 21645 22170 22745 23227 23660 24114 24648 25085 25549 25969 26384 26644 26977 27359 27682 27967 28236 28710 28884 29079 29315 29684 29958 30201 30395 30560 30739 30911 31106 31368 31610 31763 31908 32007 32169 32330 32486 32616 32735 32785 32877 32955 33072 33142 33229 33340 33415 33475 33530]; % detected deaths
H0 = [414 523 589 622 724 1004 1045 1258 1439 1439 1439 2749 2941 4025 4440 5129 6072 7024 7432 8326 9362 10361 10950 12384 13030 14620 15729 16847 18278 19388 20996 21815 22837 24392 26491 28470 30455 32534 34211 35435 37130 38092 40164 42727 44927 47055 48877 51600 54543 57576 60498 63120 64928 66624 68941 71252 75945 78249 79914 81654 82879 85231 93245 96276 99023 103031 105186 106587 109939 112541 115288 120205 122810 125176 127326 129401 132282 134560 136720 138840 140479 141981 144658 147101 150604 152844 155633 157507 158355 160092]; % detected recovered

N = 60359546; % population in IT
J = length(I0);
T1 = 2; % the date of quarantine
wC = 8;
wR = 2*wC;
T0 = datetime(2020,3,05); % the initial date for data

if (Imperial == 1) % Imperial
    alpha1 = 64; alpha2 = alpha1;
    pQ = 1.5; pN = 3.8; pR = 2.7;
else
    alpha1 = 7.7; alpha2 = alpha1;
    delay = 10; delay_pc = 30; 
    pN = 25; pQ = 2; pC = 0.1; pQR = 0; pR = 0;
end

disp(' ');
disp([' ***' Country '*** ']);
disp(' ');

script(1*delta,1*delta,2*delta_m); 
input('Press ENTER to proceed, please')
close all;

%% Spain
Country = 'Spain';

% Statistics from 12/03 (https://es.statista.com/estadisticas/1104279/personas-con-covid-19-recuperadas-por-dia-espana/ + Hopkins)
I0 = [2950 4209 5753 7753 9383 11273 13716 17147 19980 24926 28572 33089 39675 47600 56188 64059 73235 80110 87956 95923 104118 112065 119199 126168 131646 136675 141942 148220 153222 158273 166019 166831 170099 174060 180659 184948 190839 194416 198674 200210 204178 208389 213024 219764 223759 207634 209465 210773 212917 213435 215216 216582 217466 218011 219329 220325 221447 222857 223578 224390 227436 228030 228691 229540 230698 231350 231606 232037 232555 233037 234824 235290 235772 235400 236259 236769 237906 238619 239228 239429 239638 239932]; % detected infected
D0 = [84 118 136 288 309 497 598 767 982 1326 1720 2182 2696 3434 4365 5138 5982 6803 7716 8464 9387 10348 11198 11947 12641 13341 14045 14792 15447 16081 16972 17209 17756 18255 18812 19315 20002 20639 20453 20852 21282 21717 22157 22524 22902 23190 23521 23822 24275 24543 24824 25100 25264 25428 25613 25857 26070 26299 26478 26621 26744 26920 27104 27321 27563 27650 27709 27778 27888 27940 28628 28678 28752 26834 27117 27118 27119 27121 27125 27127 27127 27127]; % detected deaths
H0 = [189 193 517 517 530 1028 1081 1107 1588 2125 2575 3355 3794 5367 7015 9357 12285 14709 16780 19259 22647 26743 30513 34219 38080 40437 43208 48021 52165 55668 62391 62391 64727 67504 70853 74797 74797 74797 77357 80587 82514 85915 89250 92355 95708 98732 100875 102548 108947 112050 114678 117248 118902 121343 123486 126002 128511 131148 133952 136166 137139 138930 140823 143374 146446 149576 149576 150376 150376 150376 150376 150376 150376 150376 150376 150376 150376 150376 150376 150376 150376 150376]; % detected recovered

N = 46600396; % population in ES
J = length(I0);
T1 = 2; % the date of quarantine
wC = 8;
wR = 2*wC;
T0 = datetime(2020,3,12); % the initial date for data

if (Imperial == 1) % Imperial
    alpha1 = 95; alpha2 = alpha1;
    pQ = 1.7; pN = 4.8; pR = 3.2;
else
    alpha1 = 6.7; alpha2 = alpha1;
    delay = 8; delay_pc = 30;
    pN = 3; pQ = 0.4; pC = 0.1; pQR = 0.4; pR = 0.3;
end

disp(' ');
disp([' ***' Country '*** ']);
disp(' ');

script(1*delta,1*delta,3*delta_m);
input('Press ENTER to proceed, please')
close all;

%% Germany
Country = 'Germany';

% Statistics from 12/03 (Hopkins)
I0 = [2369 3062 3795 4838 6012 7156 8198 10999 13957 16662 18610 22672 27436 31554 36508 42288 48582 52547 57298 61913 67366 77981 84794 91159 96092 100123 103375 107663 113296 118235 122171 125452 127854 130072 132210 134753 137698 141397 143724 145742 147065 148453 150648 153129 155054 156513 157770 158758 159912 161539 163009 164077 164967 165664 166152 167007 168162 169430 170588 171324 171879 172576 173171 174098 174478 175699 176244 176551 176551 177827 178545 179021 179730 179986 18032 180600 181200 181524 182450 183025 183302 183500 183771 183879]; % detected infected
D0 = [5 5 8 12 12 12 12 20 31 47 55 86 114 149 198 253 325 389 455 583 775 931 1107 1275 1444 1584 1810 2016 2349 2607 2736 2871 3022 3194 3495 3804 4052 4352 4538 4642 4862 5086 5315 5575 5767 5877 5976 6126 6314 6467 6623 6736 6812 6866 6993 6993 7275 7392 7510 7549 7569 7661 7738 7861 7884 7913 7947 7975 8041 8112 8172 8212 8241 8274 8283 8309 8372 8449 8472 8519 8539 8546 8557 8563]; % detected deaths
H0 = [25 25 46 46 46 67 67 105 115 180 209 266 453 3290 3547 5673 6658 8481 9211 13500 16100 18700 22440 24575 26400 28700 36081 36081 46300 52407 53913 57400 64300 68200 72600 77000 81800 83114 88000 91500 95200 99400 103300 106800 109800 109800 114500 114500 120400 123500 126900 129000 130600 132700 135100 137400 139900 141700 143300 144400 145600 147200 147200 150300 150300 151597 152600 154584 155357 156881 157916 158827 159364 160016 160281 161599 161967 162820 164080 164650 165331 165552 166282 166609]; % detected recovered

N = 83042200; % population in GE (https://en.wikipedia.org/wiki/Demographics_of_Germany)
J = length(I0);
T1 = 10; % the date of quarantine
wC = 6;
wR = 2*wC;
T0 = datetime(2020,3,12); % the initial date for data

if (Imperial == 1) % Imperial
    alpha1 = 8; alpha2 = alpha1;
    pQ = 1.8; pN = 4.6; pR = 3.2;
else
    alpha1 = 3.3; alpha2 = alpha1;
    delay = 3; delay_pc = 21;
    pN = 3; pQ = 0.4; pC = 0; pQR = 0.1; pR = 0.1;
end

disp(' ');
disp([' ***' Country '*** ']);
disp(' ');

script(delta,delta,2*delta_m);
input('Press ENTER to proceed, please')
close all;

%% Brazil
Country = 'Brazil';

% Statistics from 12/03 (hopkins)
I0 = [77 151 151 200 234 346 529 640 970 1178 1546 1924 2247 2554 2985 3477 3904 4256 4661 5812 6931 8066 9216 10360 11281 12232 14049 16188 18176 19943 20964 22318 23723 25684 28912 30891 34221 36925 38654 40743 43368 46182 50036 54043 59324 63100 67446 73235 79685 87187 92202 97100 101826 108620 115953 126611 135773 146894 156061 162699 169594 178214 190137 203165 220291 233511 241080 255368 271885 291579 310087 330890 347398 363211 374898 391222 411821 438238 465166 498440 514849 526447 555383]; % detected infected
D0 = [0 0 0 0 0 1 4 7 11 18 25 34 46 59 77 93 114 136 165 202 244 327 365 445 487 566 688 820 957 1074 1141 1230 1355 1552 1760 1952 2171 2372 2462 2587 2761 2924 3331 3704 4057 4286 4603 5083 5513 6006 6412 6761 7051 7367 7958 8588 9190 10017 10656 11123 11653 12461 13240 13999 14962 15662 16122 16853 17983 18859 20047 21048 22013 22666 23473 24512 25598 26754 27878 28834 29314 29937 31199]; % detected deaths
H0 = [0 1 1 1 2 2 2 2 2 2 2 2 2 2 6 6 6 6 127 127 127 127 127 127 127 127 127 127 173 173 173 173 2979 14026 14026 14026 14026 14026 22130 22991 24325 25318 26573 27655 29160 30152 31142 32544 34132 35935 38039 40937 42991 45815 48221 51370 55350 59297 61685 64957 67384 72597 78424 79479 84970 89672 94122 100459 106794 116683 125960 135430 142587 149911 153833 158593 166647 177604 189476 200892 206555 211080 223638]; % detected recovered

N = 212559417; % population in BR
J = length(I0);
T1 = 4; % the date of quarantine
wC = 8;
wR = 2*wC;
T0 = datetime(2020,3,12); % the initial date for data

if (Imperial == 1) % No Imperial
    alpha1 = 5; alpha2 = alpha1;
    pQ = 2; pN = 12; pR = 6;
else
    alpha1 = 6.7; alpha2 = alpha1;
    delay = 3; delay_pc = 35; 
    pN = 3; pQ = 0.8; pC = 0.5; pQR = 0.5; pR = 0.8;
end

disp(' ');
disp([' ***' Country '*** ']);
disp(' ');

script(2*delta,1*delta,8*delta_m);
input('Press ENTER to proceed, please')
close all;

%% Russia
Country = 'Russia';

% Statistics from 12/03 (Wikipedia + hopkins)
I0 = [45 59 63 93 114 147 199 253 306 367 438 495 658 840 1036 1264 1534 1836 2337 2777 3548 4149 4731 4874 5410 6343 7497 8672 10131 11917 13584 15770 18328 21102 24490 27938 32007 36793 42853 47121 52763 57999 62773 68622 74588 80949 87147 93558 99399 106498 114431 124054 134687 145268 155370 165929 177160 187859 198676 209688 221344 232243 242271 252245 262843 272043 281752 290678 299941 308705 317554 326448 335882 344481 353427 362342 370680 379051 387623 396575 405843 414878 423741 432277]; % detected infected
D0 = [0 0 0 0 0 0 0 0 0 0 0 0 0 0 4 8 9 9 9 17 24 30 34 43 45 47 58 63 76 94 106 130 148 170 198 232 273 313 361 405 456 513 555 615 681 747 794 876 972 1073 1169 1222 1280 1356 1451 1537 1625 1723 1827 1915 2009 2116 2212 2305 2418 2537 2631 2722 2837 2972 3099 3249 3388 3541 3633 3807 3968 4142 4374 4555 4693 4855 5037 5215]; % detected deaths
H0 = [3 3 3 4 5 5 5 12 16 16 17 22 29 38 45 49 64 66 121 190 235 281 333 355 395 406 494 580 698 795 1045 1291 1470 1694 1986 2304 2590 3057 3291 3446 3873 4420 4891 5568 6250 6767 7346 8456 10286 11619 13220 15013 16639 18095 19865 21327 23803 26608 31916 34306 39801 43512 48003 53530 58226 63166 67373 70209 76130 85392 92681 99825 107936 113299 118798 131129 142208 150993 159257 167469 171883 175877 186985 195957]; % detected recovered

N = 146745098; % population in RU
J = length(I0);
T1 = 15; % the date of quarantine
wC = 8;
wR = 2*wC;
T0 = datetime(2020,3,12); % the initial date for data

if (Imperial == 1) % No Imperial
    alpha1 = 5; alpha2 = alpha1;
    pQ = 2; pN = 12; pR = 6;
else
    alpha1 = 1.1; alpha2 = alpha1;
    delay = 15; delay_pc = 20; 
    pN = 3; pQ = 2; pC = 0.3; pQR = 0.3; pR = 0.4;
end

disp(' ');
disp([' ***' Country '*** ']);
disp(' ');

script(1*delta,1*delta,3*delta_m);
input('Press ENTER to proceed, please')
close all;

%% NY state
Country = 'NY state';

% Statistics from 16/03 (https://en.wikipedia.org/wiki/2020_coronavirus_pandemic_in_New_York_(state))
I0 = [1374 2382 4152 7102 10356 15168 20875 25665 30811 37258 44635 52318 59513 66497 75795 83712 92381 102863 113704 122031 130689 138836 149316 159937 170512 180458 188694 195031 202208 213779 222284 229642 236732 242786 247512 251690 257216 263460 271590 282143 288045 291996 295106 299691 304372 308314 312977 316415 318953 321192 323978 327469 330407 333122 335395 337055 338485 340661 343051 345813 348232 350121 351371 352845 354370 356458 358154 359926 361515 362764 363836 364965 366733 368284 369660 370770 371711 373040];
D0 = [12 16 38 46 58 76 157 271 285 385 519 728 965 1218 1550 1941 2373 2935 3565 4159 4758 5489 6268 7067 7844 8627 9385 10056 10834 11586 12192 12822 13362 13869 14357 14828 15302 15740 16162 16599 16966 17303 17638 18015 18321 18610 18909 19189 19415 19645 20597 20828 21045 21271 21478 21640 21845 22013 22170 22304 22478 22619 22729 22843 22976 23083 23195 23282 23391 23488 23564 23632 23722 23780 23848 23905 23959 24023]; % detected deaths
H0 = [1 41 164 242 344 494 639 789 1067 1517 2045 2726 3572 4204 4975 6142 7434 8886 10478 12187 13366 14590 16353 18297 20249 22025 23887 25808 26903 27598 27994 28132 28713 29104 29593 29826 30018 31218 31962 32106 32344 32805 32904 33332 33678 34486 34689 34771 51630 53238 54597 55547 56378 57180 58006 58363 58679 59193 59758 60302 60796 61381 61681 61686 61886 62826 63292 63292 64080 64280 64280 64632 64632 65289 65289 65609 65934 66110]; % detected recovered

N = 19453561; % population in NY State (https://en.wikipedia.org/wiki/New_York_(state))
J = length(I0);
T1 = 5; % the date of quarantine
wC = 8;
wR = 2*wC;
T0 = datetime(2020,3,16); % the initial date for data

if (Imperial == 1) % Imperial
    alpha1 = 5; alpha2 = alpha1;
    pQ = 2; pN = 12; pR = 6;
else
    alpha1 = 4; alpha2 = 5*alpha1;
    delay = 5; delay_pc = 20; 
    pN = 6; pQ = .8; pC = 0.4; pQR = 0.5; pR = 0.8;
end

disp(' ');
disp([' ***' Country '*** ']);
disp(' ');

script(1*delta,1*delta,4*delta_m);
input('Press ENTER to proceed, please')
close all;

%% China
Country = 'China';

% Statistics from 16/01 (Wikipedia + hopkins)
I0 = [45 62 121 198 291 440 571 830 1287 1975 2744 4515 5974 7711 9692 11791 14380 17205 20438 24324 28018 31161 34546 37198 40171 42638 44653 39571 40364 40381 40007 70548 72436 74185 75002 75891 76288 76936 77150 77658 78064 78497 78824 79251 79824 80026 80151 80270 80409 80552 80651 80695 80735 80754 80778 80793 80813 80824 80844 80860 80881 80894 80928 80967 81008 81054 81093 81171 81218 81285 81340 81394 81439 81470 81518 81554 81589 81620 81639 81669 81708 81740 81802 81865 82924 83014 83134 83135 83302 83351 83402 83753 83784 83804 83817 83849 83864 83876 83884 83899 83909 83912 83938 83940 83944 83956 83959 83959 83964 83966 83968 83970 83976 83976 83990 84010 84011 84018 84024 84029 84038 84044 84054 84063 84063 84063 84079 84081 84084 84095 84102 84103 84106 84106 84123 84130 84147 84154 84159]; % detected infected
D0 = [2 2 3 4 6 9 17 25 41 56 80 106 132 170 213 259 304 361 425 490 563 637 722 811 908 1016 1113 1259 1380 1523 1665 1770 1868 2004 2118 2236 2345 2443 2592 2663 2715 2744 2788 2835 2870 2912 2943 2981 3012 3042 3070 3097 3119 3136 3158 3169 3176 3189 3199 3213 3226 3237 3245 3248 3255 3261 3270 3277 3281 3287 3292 3295 3300 3304 3305 3312 3318 3322 3326 3329 3331 3331 3333 3335 3340 3343 3343 3343 3345 3346 3346 4636 4636 4636 4636 4636 4636 4636 4636 4636 4636 4637 4637 4637 4637 4637 4637 4637 4637 4637 4637 4637 4637 4637 4637 4637 4637 4637 4637 4637 4637 4638 4638 4638 4638 4638 4638 4638 4638 4638 4638 4638 4638 4638 4638 4638 4638 4638 4638]; % detected deaths
H0 = [15 19 24 25 25 25 25 34 38 49 51 60 103 124 171 243 328 475 632 892 1153 1540 2050 2649 3281 3996 4740 5642 6723 8096 9419 10844 12545 14376 16155 18264 20659 22401 24734 27323 29745 32945 36117 39002 41625 44462 47204 49856 52045 53726 55404 57065 58600 59897 61475 62793 64111 65541 66911 67749 68679 69601 70420 71150 71740 72244 72703 73159 73650 74051 74588 74971 75448 75770 76052 76238 76408 76571 76751 76964 77078 77167 77279 77370 77758 77874 77953 77956 78148 78265 78370 77480 77578 77647 77706 77775 77827 77911 77997 78109 78185 78277 78377 78435 78476 78523 78581 78586 78684 78792 78870 78929 78977 78993 79127 79167 79202 79224 79251 79263 79282 79293 79306 79310 79310 79310 79329 79332 79336 79347 79352 79360 79367 79379 79383 79387 79389 79398 79398]; % detected recovered

N = 1438070898; % population in CN https://www.worldometers.info/world-population/china-population/
J = length(I0);
T1 = 13; % the date of quarantine 29/01
T0 = datetime(2020,1,16); % the initial date for data
J_id = 60;

alpha1 = 1; alpha2 = alpha1; % alpha1 = 3;
delay = 1; delay_pc = 15;
% Confinement parameters for China
pQ = 2; pN = 30; pR = 0.1; pC = 0; pQR = 0; 

% Scenario for China
wC = 9; % weeks in quarantine
wR = 2*wC; % weeks in relaxed quarantine
NC = 1; % number cycles to simulate

disp(' ');
disp([' ***' Country '*** ']);
disp(' ');

script(1*delta,1*delta,5*delta_m);
disp('Stop execution')